<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soulfood üç≤</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-royal: #0c2461;      
            --bg-overlay: rgba(12, 36, 97, 0.95);
            --text-platinum: #E5E4E2; 
            --gold: #D4AF37;          
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-royal);
            color: var(--text-platinum);
            margin: 0;
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 100 100'%3E%3Ctext y='50%25' x='50%25' dominant-baseline='middle' text-anchor='middle' font-size='35' fill='%23D4AF37' opacity='0.15'%3E‚öúÔ∏è%3C/text%3E%3C/svg%3E");
            background-repeat: repeat;
        }

        .container {
            background: rgba(20, 30, 60, 0.95);
            padding: 1.5rem;
            border-radius: var(--radius);
            border: 3px double var(--gold);
            box-shadow: 0 15px 50px rgba(0,0,0,0.8);
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
            margin-bottom: 60px;
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 10;
        }

        .ornament { position: fixed; bottom: 15px; font-size: 1.5rem; color: var(--gold); opacity: 0.8; pointer-events: none; z-index: 20; }
        .ornament.left { left: 15px; }
        .ornament.right { right: 15px; }
        .container::before, .container::after { content: "‚öúÔ∏è"; position: absolute; font-size: 1.2rem; color: var(--gold); opacity: 0.8; }
        .container::before { top: 10px; left: 10px; }
        .container::after { top: 10px; right: 10px; }

        h1 { 
            color: var(--gold); text-align: center; margin: 10px 0 5px 0;
            font-family: 'Playfair Display', serif; font-size: clamp(2.2rem, 8vw, 2.8rem);
            line-height: 1.1; text-shadow: 0 3px 6px rgba(0,0,0,0.4); letter-spacing: 1px;
        }
        
        .subtitle { 
            text-align: center; color: var(--text-platinum); opacity: 0.8; margin-bottom: 25px; 
            font-weight: 300; letter-spacing: 2px; text-transform: uppercase; font-size: 0.75rem;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3); display: inline-block; padding-bottom: 5px; width: 100%;
        }

        h2 { 
            font-family: 'Playfair Display', serif; color: var(--gold); font-size: 1.4rem; 
            margin-top: 0; margin-bottom: 15px; text-align: center;
        }
        
        .btn {
            width: 100%; padding: 18px; margin-top: 20px; border: none; border-radius: 12px;
            background: linear-gradient(135deg, var(--gold), #8e7318); color: #05102a;
            font-size: 1.1rem; font-weight: 700; font-family: 'Playfair Display', serif;
            text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); user-select: none; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-outline {
            background: transparent; border: 2px solid var(--gold); color: var(--gold); margin-top: 10px;
        }

        .step { display: none; animation: fadeIn 0.5s ease-out; }
        .step.active { display: block; }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        
        .option-card {
            background: rgba(255, 255, 255, 0.05); padding: 15px 10px; border-radius: 10px;
            text-align: center; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.2); 
            font-weight: 400; color: var(--text-platinum); font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center; min-height: 60px; 
            transition: all 0.2s; flex-direction: column;
        }
        .option-card.selected {
            border-color: var(--gold); background-color: rgba(212, 175, 55, 0.15); 
            color: var(--gold); font-weight: bold; box-shadow: 0 0 15px rgba(212, 175, 55, 0.1);
        }
        .option-card span { font-size: 1.5rem; margin-bottom: 5px; display: block; }

        label {
            color: var(--gold); font-family: 'Playfair Display', serif; font-size: 1.1rem;
            display: block; margin-top: 25px; margin-bottom: 10px; text-align: center;
        }

        input {
            width: 100%; padding: 15px; border: 1px solid rgba(212, 175, 55, 0.4);
            border-radius: 10px; font-size: 16px; font-family: 'Lato', sans-serif;
            background: rgba(0, 0, 0, 0.3); color: var(--text-platinum);
            -webkit-appearance: none; text-align: center;
        }
        input:focus { outline: none; border-color: var(--gold); background: rgba(0, 0, 0, 0.5); }

        .api-details {
            margin-top: 30px; font-size: 0.8rem; color: rgba(255,255,255,0.4); 
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; text-align: center;
        }
        .api-details input { font-size: 0.8rem; padding: 10px; margin-top: 10px; }

        .result-img {
            width: 100%; height: auto; aspect-ratio: 4/3; object-fit: cover;
            border-radius: 12px; margin-bottom: 20px; background-color: #0c2461;
            border: 2px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .recipe-box {
            background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 20px;
            margin: 20px 0; text-align: left; line-height: 1.6; color: var(--text-platinum);
            border-left: 3px solid var(--gold); font-size: 0.95rem;
        }

        .ingredient-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .ingredient-list li {
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center;
        }
        .ingredient-list input[type="checkbox"] {
            width: auto; margin-right: 10px; transform: scale(1.2); accent-color: var(--gold);
        }

        .drink-suggestion {
            background: linear-gradient(to right, rgba(212, 175, 55, 0.15), transparent);
            padding: 15px; border-radius: 12px; margin-top: 20px;
            display: flex; align-items: flex-start; gap: 15px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .loader {
            border: 3px solid rgba(212, 175, 55, 0.2); border-top: 3px solid var(--gold);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 30px auto;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="ornament left">‚öúÔ∏è</div>
<div class="ornament right">‚öúÔ∏è</div>

<div class="container">
    
    <div id="step-setup" class="step active">
        <h1>Soulfood üç≤</h1>
        <div class="subtitle">Essen, das gl√ºcklich macht.</div>
        <p style="text-align:center; color:#E5E4E2; font-size: 0.95rem; line-height: 1.6;">
            Dein kulinarischer Kompass.<br>Vom Sofa direkt ins Gl√ºck.
        </p>
        <button class="btn" onclick="startApp()">Starten</button>
        <div class="api-details">
            <span onclick="toggleApiInput()" style="cursor:pointer; text-decoration:underline;">Erweiterte Einstellungen (KI Key)</span>
            <div id="apiInputWrapper" style="display:none;">
                <input type="password" id="apiKey" placeholder="Google API Key (Optional)">
                <p style="margin-top:5px; font-size:0.7rem;">Leer lassen f√ºr Offline-Modus.</p>
            </div>
        </div>
    </div>

    <div id="step-mode" class="step">
        <h2>Der Plan?</h2>
        <div class="options-grid">
            <div class="option-card" onclick="selectMode('cook', this)">
                <span>üë®‚Äçüç≥</span>Selber Kochen<br><small style="font-size:0.7rem">Rezept & Einkauf</small>
            </div>
            <div class="option-card" onclick="selectMode('order', this)">
                <span>üõµ</span>Bestellen<br><small style="font-size:0.7rem">Lieferdienst</small>
            </div>
            <div class="option-card" onclick="selectMode('out', this)">
                <span>üó∫Ô∏è</span>Essen gehen<br><small style="font-size:0.7rem">Restaurant</small>
            </div>
        </div>
        <div style="height:20px;"></div>
    </div>

    <div id="step-category" class="step">
        <h2>Worauf habt ihr Lust?</h2>
        <div class="options-grid" id="catGrid"></div>
        <button class="btn" onclick="nextStep('step-count')">Weiter</button>
    </div>

    <div id="step-count" class="step">
        <h2>Wie viele seid ihr?</h2>
        <input type="number" id="peopleCount" value="2" min="1" inputmode="numeric">
        <button class="btn" onclick="startPlayerLoop()">Weiter zu den W√ºnschen</button>
    </div>

    <div id="step-individual" class="step">
        <h2 id="personTitle">Person 1</h2>
        <p style="text-align:center; font-size:0.8rem; margin-top:-10px;">Gib das Handy weiter!</p>
        
        <label>Ern√§hrungsweise</label>
        <div class="options-grid" id="dietGrid">
            <div class="option-card selected" onclick="selectIndividual('diet', 'Alles', this)">Alles</div>
            <div class="option-card" onclick="selectIndividual('diet', 'Vegetarisch', this)">Vegetarisch</div>
            <div class="option-card" onclick="selectIndividual('diet', 'Vegan', this)">Vegan</div>
            <div class="option-card" onclick="selectIndividual('diet', 'Pescetarisch', this)">Fisch</div>
        </div>

        <label>Geschmack (Worauf hast DU Bock?)</label>
        <div class="options-grid" id="tasteGrid">
            <div class="option-card" onclick="selectIndividual('taste', 'Herzhaft', this)">Herzhaft</div>
            <div class="option-card" onclick="selectIndividual('taste', 'S√º√ü', this)">S√º√ü</div>
            <div class="option-card" onclick="selectIndividual('taste', 'Deftig', this)">Deftig</div>
            <div class="option-card" onclick="selectIndividual('taste', 'Leicht', this)">Leicht</div>
            <div class="option-card" onclick="selectIndividual('taste', 'Scharf', this)">Scharf</div>
            <div class="option-card" onclick="selectIndividual('taste', 'Herb', this)">Herb</div>
        </div>

        <label>Getr√§nke</label>
        <div class="options-grid" id="drinkGrid">
            <div class="option-card selected" onclick="selectIndividual('drink', 'non-alcoholic', this)">Alkoholfrei</div>
            <div class="option-card" onclick="selectIndividual('drink', 'alcoholic', this)">Mit Alkohol</div>
        </div>

        <label>Allergien / No-Gos</label>
        <input type="text" id="individualAllergies" placeholder="z.B. N√ºsse, Pilze...">
        
        <button class="btn" id="nextPersonBtn" onclick="nextPerson()">N√§chste Person</button>
    </div>

    <div id="step-loading" class="step" style="text-align: center;">
        <h2 style="color:var(--gold); border:none; margin-top:40px;">Kuratierung...</h2>
        <div class="loader"></div>
        <p id="loadingText" style="color:var(--text-platinum); opacity:0.7; font-size:0.9rem;">Wir suchen den kleinsten gemeinsamen Nenner.</p>
    </div>

    <div id="step-result" class="step">
        <h2 id="resTitle" style="font-family: 'Playfair Display', serif; font-size:2rem; margin-bottom:15px; color: var(--gold); border:none; text-align: center;">Gericht</h2>
        
        <img id="resImg" class="result-img" src="" alt="Exquisites Essen">
        
        <p id="resDesc" style="text-align: center; color: var(--text-platinum); font-style: italic; font-size: 1rem; margin-bottom: 25px;"></p>

        <div id="actionButtons" style="display:none; margin-bottom:20px;">
            <button class="btn" id="mapBtn" onclick="openMaps()">üó∫Ô∏è Restaurants auf Maps zeigen</button>
            <button class="btn" id="deliveryBtn" onclick="openDelivery()">üõµ Lieferdienst suchen</button>
        </div>

        <div id="cookingDetails" style="display:none;">
            <div class="recipe-box">
                <h3 style="color:var(--gold); margin-top:0;">üìù Einkaufsliste</h3>
                <ul id="ingredientList" class="ingredient-list"></ul>
                <h3 style="color:var(--gold); margin-top:20px;">üî• Zubereitung</h3>
                <p id="resSteps" style="white-space: pre-line; margin-bottom:0;"></p>
            </div>
        </div>

        <div class="drink-suggestion">
            <span style="font-size: 2rem;">ü•Ç</span>
            <div>
                <strong id="drinkName" style="color:var(--gold); font-size:0.9rem; text-transform: uppercase;">Empfehlung</strong>
                <div id="drinkReason" style="font-size: 0.9rem; color: var(--text-platinum); opacity: 0.9; margin-top:4px;"></div>
            </div>
        </div>

        <button class="btn btn-outline" onclick="location.reload()">Neue Runde</button>
    </div>

</div>

<script>
    const STORAGE_KEY = "soulfood_ultra_v3";
    let apiKey = localStorage.getItem(STORAGE_KEY) || "";
    
    function toggleApiInput() {
        const wrapper = document.getElementById('apiInputWrapper');
        wrapper.style.display = wrapper.style.display === 'none' ? 'block' : 'none';
    }

    if(apiKey) document.getElementById('apiKey').value = apiKey;

    // STATE
    let globalSettings = { mode: "cook", category: "", peopleCount: 1 };
    let players = []; // Array speichert { diet: "", taste: "", drink: "", allergy: "" }
    let currentPlayerIndex = 0;
    let tempPlayerSelection = { diet: "Alles", taste: "", drink: "non-alcoholic" };

    const categories = ["Fr√ºhst√ºck", "Brunch", "Mittagessen", "Abendessen", "Snacks", "Dessert", "Suppen", "Nur Drinks"];

    // --- DATENBANK MIT GESCHMACKS-TAGS (taste) ---
    const offlineDatabase = [
        // FR√úHST√úCK
        { name: "Egg Benedict Royal", category: "Fr√ºhst√ºck", taste: "Herzhaft", diet: "Alles", desc: "Pochierte Eier auf Brioche mit Sauce Hollandaise.", drink: "Mimosa", drinkReason: "Klassiker.", img: "Eggs Benedict gourmet", ingredients: ["Eier", "Brioche", "Butter", "Schinken"], steps: "1. Pochieren.\n2. Sauce r√ºhren." },
        { name: "Avocado Toast Deluxe", category: "Fr√ºhst√ºck", taste: "Leicht", diet: "Vegan", desc: "Sauerteigbrot mit Avocado und Chili.", drink: "Ingwer-Shot", drinkReason: "Belebend.", img: "Avocado toast pomegranate", ingredients: ["Brot", "Avocado", "Chili", "Limette"], steps: "1. R√∂sten.\n2. Belegen." },
        { name: "Pancakes mit Ahornsirup", category: "Fr√ºhst√ºck", taste: "S√º√ü", diet: "Vegetarisch", desc: "Fluffige Pfannkuchen.", drink: "Kakao", drinkReason: "S√º√ü.", img: "Pancakes syrup", ingredients: ["Mehl", "Milch", "Ei", "Sirup"], steps: "1. Teig r√ºhren.\n2. Backen." },
        { name: "Full English Breakfast", category: "Fr√ºhst√ºck", taste: "Deftig", diet: "Alles", desc: "W√ºrstchen, Speck, Bohnen.", drink: "Earl Grey", drinkReason: "Britisch.", img: "Full english breakfast", ingredients: ["W√ºrstchen", "Speck", "Bohnen", "Ei"], steps: "1. Alles braten." },
        
        // MITTAG
        { name: "Tr√ºffel-Pasta", category: "Mittagessen", taste: "Herzhaft", diet: "Vegetarisch", desc: "Pasta mit Butter und schwarzem Tr√ºffel.", drink: "Chardonnay", drinkReason: "Edel.", img: "Truffle pasta gourmet", ingredients: ["Pasta", "Butter", "Tr√ºffel", "Parmesan"], steps: "1. Kochen.\n2. Schwenken." },
        { name: "Buddha Bowl", category: "Mittagessen", taste: "Leicht", diet: "Vegan", desc: "Quinoa, S√º√ükartoffel, Tahini.", drink: "Kombucha", drinkReason: "Gesund.", img: "Buddha bowl", ingredients: ["Quinoa", "S√º√ükartoffel", "Kichererbsen"], steps: "1. Garen.\n2. Anrichten." },
        { name: "Currywurst mit Pommes", category: "Mittagessen", taste: "Deftig", diet: "Alles", desc: "Der Klassiker.", drink: "Cola", drinkReason: "Kult.", img: "Currywurst fries", ingredients: ["Wurst", "Currysauce", "Pommes"], steps: "1. Braten.\n2. Frittieren." },
        { name: "Linseneintopf", category: "Mittagessen", taste: "Deftig", diet: "Alles", desc: "Klassisch mit W√ºrstchen.", drink: "Apfelschorle", drinkReason: "Bodenst√§ndig.", img: "Lentil soup", ingredients: ["Linsen", "Suppengr√ºn", "W√ºrstchen"], steps: "1. Kochen." },

        // ABEND
        { name: "Rinderfilet", category: "Abendessen", taste: "Herzhaft", diet: "Alles", desc: "Zartes Steak mit Rotweinjus.", drink: "Rotwein", drinkReason: "Kr√§ftig.", img: "Filet Mignon steak", ingredients: ["Filet", "Rotwein", "Kartoffeln"], steps: "1. Braten." },
        { name: "Thai Green Curry", category: "Abendessen", taste: "Scharf", diet: "Vegan", desc: "Scharfes Kokoscurry.", drink: "Bier", drinkReason: "L√∂scht.", img: "Thai green curry", ingredients: ["Currypaste", "Kokosmilch", "Gem√ºse"], steps: "1. Kochen." },
        { name: "Wiener Schnitzel", category: "Abendessen", taste: "Deftig", diet: "Alles", desc: "Kalbsschnitzel paniert.", drink: "Wei√üwein", drinkReason: "Klassik.", img: "Wiener Schnitzel", ingredients: ["Kalb", "Paniermehl", "Ei"], steps: "1. Panieren.\n2. Backen." },
        { name: "Sommersalat mit Ziegenk√§se", category: "Abendessen", taste: "Leicht", diet: "Vegetarisch", desc: "Frischer Salat mit Honig.", drink: "Ros√©", drinkReason: "Sommerlich.", img: "Goat cheese salad", ingredients: ["Salat", "Ziegenk√§se", "Honig"], steps: "1. Grillen.\n2. Mischen." },
        { name: "Chili sin Carne", category: "Abendessen", taste: "Scharf", diet: "Vegan", desc: "Scharfer Bohneneintopf.", drink: "Corona", drinkReason: "Mildert.", img: "Chili sin carne", ingredients: ["Bohnen", "Tomaten", "Soja", "Chili"], steps: "1. Einkochen." },
        
        // SNACKS
        { name: "Nachos Supreme", category: "Snacks", taste: "Deftig", diet: "Vegetarisch", desc: "K√§se, Jalapenos.", drink: "Bier", drinkReason: "Passt.", img: "Nachos cheese supreme", ingredients: ["Chips", "K√§se", "Jalapenos"], steps: "1. √úberbacken." },
        { name: "Edamame", category: "Snacks", taste: "Leicht", diet: "Vegan", desc: "Sojabohnen mit Salz.", drink: "Sake", drinkReason: "Japanisch.", img: "Edamame beans", ingredients: ["Edamame", "Salz"], steps: "1. D√§mpfen." },
        { name: "Chicken Wings", category: "Snacks", taste: "Scharf", diet: "Alles", desc: "Hot BBQ Wings.", drink: "Pale Ale", drinkReason: "BBQ.", img: "Spicy chicken wings", ingredients: ["Wings", "Hot Sauce"], steps: "1. Backen." },

        // DESSERT
        { name: "Lava Cake", category: "Dessert", taste: "S√º√ü", diet: "Vegetarisch", desc: "Schokok√ºchlein.", drink: "Espresso", drinkReason: "Kontrast.", img: "Chocolate lava cake", ingredients: ["Schoko", "Ei", "Butter", "Zucker"], steps: "1. Backen." },
        { name: "Zitronensorbet", category: "Dessert", taste: "Sauer", diet: "Vegan", desc: "Erfrischend.", drink: "Wodka", drinkReason: "Colonel.", img: "Lemon sorbet", ingredients: ["Zitrone", "Zucker", "Wasser"], steps: "1. Frieren." },
        { name: "Kaiserschmarrn", category: "Dessert", taste: "S√º√ü", diet: "Vegetarisch", desc: "Mit Rosinen.", drink: "Almdudler", drinkReason: "Alpen.", img: "Kaiserschmarrn", ingredients: ["Mehl", "Ei", "Milch", "Rosinen"], steps: "1. Pfanne." },

        // DRINKS
        { name: "Gin Tonic", category: "Nur Drinks", taste: "Herb", diet: "Vegan", desc: "Klassiker.", drink: "-", drinkReason: "-", img: "Gin Tonic", ingredients: ["Gin", "Tonic", "Gurke"], steps: "1. Mischen." },
        { name: "Mojito", category: "Nur Drinks", taste: "S√º√ü", diet: "Vegan", desc: "Minze & Rum.", drink: "-", drinkReason: "-", img: "Mojito", ingredients: ["Rum", "Minze", "Zucker"], steps: "1. Mischen." },
        { name: "Negroni", category: "Nur Drinks", taste: "Bitter", diet: "Vegan", desc: "Stark & Bitter.", drink: "-", drinkReason: "-", img: "Negroni", ingredients: ["Gin", "Wermut", "Campari"], steps: "1. R√ºhren." }
    ];

    window.onload = () => renderCategories();

    window.renderCategories = () => {
        const grid = document.getElementById('catGrid');
        categories.forEach(cat => {
            const el = document.createElement('div');
            el.className = 'option-card';
            el.innerText = cat;
            el.onclick = () => {
                document.querySelectorAll('#catGrid .option-card').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                globalSettings.category = cat;
            };
            grid.appendChild(el);
        });
    };

    window.startApp = () => {
        const inputKey = document.getElementById('apiKey').value.trim();
        if(inputKey.length > 5) {
            localStorage.setItem(STORAGE_KEY, inputKey);
            apiKey = inputKey;
        }
        document.getElementById('step-setup').classList.remove('active');
        document.getElementById('step-mode').classList.add('active');
    };

    window.selectMode = (mode, el) => {
        globalSettings.mode = mode;
        document.querySelectorAll('#step-mode .option-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        setTimeout(() => nextStep('step-category'), 300);
    };
    
    window.nextStep = (id) => {
        if(id === 'step-count' && !globalSettings.category) {
            alert("Bitte w√§hle eine Kategorie."); return;
        }
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    };

    // --- PLAYER LOOP LOGIK ---
    window.startPlayerLoop = () => {
        globalSettings.peopleCount = parseInt(document.getElementById('peopleCount').value);
        currentPlayerIndex = 1;
        players = []; // Reset
        showPlayerInput();
        window.nextStep('step-individual');
    };

    function showPlayerInput() {
        document.getElementById('personTitle').innerText = `Person ${currentPlayerIndex} von ${globalSettings.peopleCount}`;
        document.getElementById('nextPersonBtn').innerText = (currentPlayerIndex === globalSettings.peopleCount) ? "Fertig - Gericht finden!" : "N√§chste Person";
        
        // Reset Inputs
        document.getElementById('individualAllergies').value = "";
        resetGrid('dietGrid');
        resetGrid('tasteGrid');
        resetGrid('drinkGrid');
        
        // Default Selection
        selectIndividual('drink', 'non-alcoholic', document.querySelector('#drinkGrid .option-card'));
        selectIndividual('diet', 'Alles', document.querySelector('#dietGrid .option-card'));
        tempPlayerSelection = { diet: "Alles", taste: "", drink: "non-alcoholic", allergy: "" };
    }

    function resetGrid(id) {
        document.querySelectorAll(`#${id} .option-card`).forEach(c => c.classList.remove('selected'));
    }

    window.selectIndividual = (type, val, el) => {
        el.parentElement.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        tempPlayerSelection[type] = val;
    };

    window.nextPerson = () => {
        // Speichere aktuellen Spieler
        tempPlayerSelection.allergy = document.getElementById('individualAllergies').value;
        players.push({...tempPlayerSelection}); // Copy object

        if (currentPlayerIndex < globalSettings.peopleCount) {
            currentPlayerIndex++;
            showPlayerInput();
            window.scrollTo(0,0);
        } else {
            generateFood();
        }
    };

    // --- KI & LOGIK ---
    async function fetchFromAPI(prompt) {
        if(!apiKey || apiKey.length < 10) throw new Error("No Key");
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!response.ok) throw new Error("API Fail");
        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(text);
    }

    function fetchFromOfflineDB() {
        // CONSENSUS LOGIK
        let finalDiet = "Alles";
        if (players.some(p => p.diet === "Vegan")) finalDiet = "Vegan";
        else if (players.some(p => p.diet === "Vegetarisch")) finalDiet = "Vegetarisch";
        else if (players.some(p => p.diet === "Pescetarisch")) finalDiet = "Pescetarisch";

        // Sammle alle Geschm√§cker
        let wantedTastes = players.map(p => p.taste).filter(t => t !== "");

        let possible = offlineDatabase.filter(d => {
            const catMatch = d.category === globalSettings.category || (globalSettings.category === "Brunch" && d.category === "Fr√ºhst√ºck");
            
            // Diet Check (Strict)
            let dietMatch = true;
            if (finalDiet === "Vegan" && d.diet !== "Vegan") dietMatch = false;
            if (finalDiet === "Vegetarisch" && (d.diet === "Alles" || d.diet === "Pescetarisch")) dietMatch = false;
            if (finalDiet === "Pescetarisch" && d.diet === "Alles") dietMatch = false;

            // Taste Check (Soft - einer muss passen)
            let tasteMatch = true;
            if (wantedTastes.length > 0) {
                // Wenn wir W√ºnsche haben, muss das Gericht einen davon erf√ºllen ODER neutral sein
                // Hier: Einfache Logik -> Wenn Taste angegeben, muss es passen, sonst alles
                if (!wantedTastes.includes(d.taste) && wantedTastes.length > 0) {
                    // Wir geben Punkten, wenn es passt. Hier simpler Filter:
                    // Wenn keiner der W√ºnsche passt, fliegt es raus? Zu streng.
                    // Wir lassen es drin, sortieren aber sp√§ter vielleicht.
                    // F√ºr MVP: Wir filtern nicht hart nach Taste im Offline Mode, 
                    // da die DB zu klein ist f√ºr "Vegan + Scharf + S√º√ü".
                }
            }

            return catMatch && dietMatch;
        });

        if(possible.length === 0) {
            // Fallback: Nur Kategorie filtern, Diet ignorieren (Notfall)
            possible = offlineDatabase.filter(d => d.category === globalSettings.category);
        }
        
        const item = possible[Math.floor(Math.random() * possible.length)];
        
        return {
            dishName: item.name,
            description: item.desc,
            drinkName: item.drink,
            drinkReason: item.drinkReason,
            recipeShort: "Zubereitung siehe unten.",
            ingredients: item.ingredients || ["Zutaten laden..."],
            steps: item.steps || "Schritte laden...",
            imageSearchTerm: item.img
        };
    }

    window.generateFood = async () => {
        window.nextStep('step-loading');
        
        // Prompt bauen aus allen Spielern
        let playerDesc = players.map((p, i) => `Person ${i+1}: ${p.diet}, mag ${p.taste}, trinkt ${p.drink}, Allergie: ${p.allergy}`).join(". ");

        const prompt = `
            Finde ein gemeinsames Gericht f√ºr diese Gruppe. Kategorie: ${globalSettings.category}.
            Profile: ${playerDesc}.
            Das Gericht muss den strengsten Ern√§hrungsstil erf√ºllen (Vegan > Veggie > Alles).
            Antworte als JSON: 
            { 
                "dishName": "...", 
                "description": "...", 
                "drinkName": "...", 
                "drinkReason": "...", 
                "ingredients": ["Zutat 1", "Zutat 2"],
                "steps": "1... 2...",
                "imageSearchTerm": "..." 
            }
        `;

        let data;
        try {
            data = await fetchFromAPI(prompt);
        } catch (e) {
            await new Promise(r => setTimeout(r, 1200)); 
            data = fetchFromOfflineDB();
        }

        const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(data.imageSearchTerm + " elegant gourmet food photography dark rich colors cinematic lighting 8k")}`;

        document.getElementById('resTitle').innerText = data.dishName;
        document.getElementById('resDesc').innerText = data.description;
        document.getElementById('resImg').src = imgUrl;
        document.getElementById('drinkName').innerText = data.drinkName;
        document.getElementById('drinkReason').innerText = data.drinkReason;

        // Modus Logik
        const actionBtns = document.getElementById('actionButtons');
        const cookingDet = document.getElementById('cookingDetails');
        
        actionBtns.style.display = 'none';
        cookingDet.style.display = 'none';

        if (globalSettings.mode === 'cook') {
            cookingDet.style.display = 'block';
            const ingList = document.getElementById('ingredientList');
            ingList.innerHTML = '';
            if(data.ingredients) {
                data.ingredients.forEach(ing => {
                    const li = document.createElement('li');
                    li.innerHTML = `<input type="checkbox"> ${ing}`;
                    ingList.appendChild(li);
                });
            }
            document.getElementById('resSteps').innerText = data.steps || data.recipeShort;

        } else {
            actionBtns.style.display = 'block';
            const mapBtn = document.getElementById('mapBtn');
            const delBtn = document.getElementById('deliveryBtn');
            
            if (globalSettings.mode === 'out') {
                mapBtn.style.display = 'block';
                delBtn.style.display = 'none';
                mapBtn.onclick = () => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(data.dishName + " Restaurant")}`);
            } else {
                mapBtn.style.display = 'none';
                delBtn.style.display = 'block';
                delBtn.onclick = () => window.open(`https://www.google.com/search?q=${encodeURIComponent("Lieferdienst " + data.dishName)}`);
            }
        }

        window.nextStep('step-result');
    };
</script>

</body>
</html>
